# LDSæŒ‡ä»¤æ€§èƒ½å¯¹æ¯”åˆ†ææŠ¥å‘Š

## å®éªŒè®¾ç½®

**è®¾å¤‡**: AMD Instinct MI300X VF  
**æ¶æ„**: CDNA3 (gfx942)  
**é…ç½®**: WARP_M=64, MMA_M=16, MMA_K=16, 256 threads/block

## å…³é”®å‘ç°

### 1. æŒ‡ä»¤ç”Ÿæˆç»Ÿè®¡

ä»ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ä¸­å‘ç°ï¼š

| æŒ‡ä»¤ç±»å‹ | å‡ºç°æ¬¡æ•° | ä½¿ç”¨åœºæ™¯ |
|---------|---------|---------|
| `ds_read2st64_b64` | 2 | Compact layout (BLOCK_K=16) |
| `ds_read2_b64` | 8 | Strided layout (BLOCK_K=64) |
| å…¶ä»– `ds_read*` | 64 | å„ç§åˆå§‹åŒ–å’Œæ‚é¡¹è¯»å– |

**æ„å¤–å‘ç°**: ä¸é¢„æœŸç›¸åï¼
- `ds_read2st64_b64` å‡ºç°åœ¨**compact layout** (å°stride)
- `ds_read2_b64` å‡ºç°åœ¨**strided layout** (å¤§stride)

### 2. æ€§èƒ½æµ‹è¯•ç»“æœ

| Layoutç±»å‹ | å¹³å‡æ—¶é—´ | ç›¸å¯¹æ€§èƒ½ | è¯´æ˜ |
|-----------|---------|----------|------|
| Compact (K=16) | **145.3 Âµs** | åŸºå‡† (100%) | è¿ç»­è®¿é—®ï¼Œæœ€å¿« |
| Strided (K=64) | 405.1 Âµs | æ…¢178.9% | è·¨strideè®¿é—® |
| Transpose | 384.7 Âµs | æ…¢164.8% | è½¬ç½®è®¿é—®æ¨¡å¼ |

**æ€§èƒ½ç»“è®º**:
- Compact layout **å¿«2.79å€** vs Strided layout
- Compact layout **å¿«2.65å€** vs Transpose access
- LDSå¸ƒå±€å¯¹æ€§èƒ½çš„å½±å“**è¿œå¤§äº**æŒ‡ä»¤ç±»å‹æœ¬èº«ï¼

## æ±‡ç¼–ä»£ç åˆ†æ

### `ds_read2st64_b64` ä½¿ç”¨ç¤ºä¾‹ (Compact Layout)

```assembly
; åœ°å€è®¡ç®—
v_and_b32_e32 v1, 12, v1
v_lshlrev_b32_e32 v1, 1, v1

; ä½¿ç”¨stride=64æŒ‡ä»¤è¯»å–
ds_read2st64_b64 v[2:5], v1 offset1:1      ; è¯»å– v1 å’Œ v1+512B
ds_read2st64_b64 v[6:9], v1 offset0:2 offset1:3  ; è¯»å– v1+1024B å’Œ v1+1536B
```

**ç‰¹ç‚¹**:
- offsetå•ä½æ˜¯ 64Ã—8 = 512 å­—èŠ‚
- `offset1:1` è¡¨ç¤ºç¬¬äºŒä¸ªåœ°å€åœ¨ base + 512 å­—èŠ‚
- ä¸€æ¬¡è¯»å–16å­—èŠ‚ (4ä¸ªfloatæˆ–8ä¸ªbf16)

### `ds_read2_b64` ä½¿ç”¨ç¤ºä¾‹ (Strided Layout)

```assembly
; åœ°å€è®¡ç®—ï¼ˆæ›´å¤æ‚ï¼‰
v_and_or_b32 v1, v2, s3, v1
v_lshlrev_b32_e32 v26, 1, v1

; æ ‡å‡†offsetè¯»å–
ds_read2_b64 v[2:5], v26 offset1:4         ; è¯»å– v26 å’Œ v26+32B
v_add_u32_e32 v14, 0x800, v26              ; æ‰‹åŠ¨è®¡ç®—ä¸‹ä¸€ä¸ªåœ°å€
ds_read2_b64 v[10:13], v14 offset1:4       ; ç»§ç»­è¯»å–
ds_read2_b64 v[14:17], v14 offset0:8 offset1:12  ; æ›´å¤šè¯»å–
```

**ç‰¹ç‚¹**:
- offsetå•ä½æ˜¯ 8 å­—èŠ‚
- `offset1:4` è¡¨ç¤ºç¬¬äºŒä¸ªåœ°å€åœ¨ base + 32 å­—èŠ‚
- éœ€è¦æ›´å¤šæŒ‡ä»¤æ¥è®¡ç®—å¤§è·¨åº¦åœ°å€ï¼ˆ`v_add_u32_e32 v14, 0x800, v26`ï¼‰

## æ·±åº¦åˆ†æ

### ä¸ºä»€ä¹ˆæŒ‡ä»¤é€‰æ‹©ä¸é¢„æœŸç›¸åï¼Ÿ

ç¼–è¯‘å™¨çš„é€‰æ‹©ç­–ç•¥ï¼š

1. **Compact layout (K=16)** ä½¿ç”¨ `ds_read2st64_b64`:
   - æ•°æ®æ€»é‡å°ï¼Œåœ°å€é›†ä¸­
   - stride=512B æ­£å¥½åŒ¹é…æŸäº›è®¿é—®æ¨¡å¼
   - **å°‘æ•°å‡ ä¸ªæŒ‡ä»¤å°±èƒ½è¦†ç›–æ‰€æœ‰æ•°æ®**

2. **Strided layout (K=64)** ä½¿ç”¨ `ds_read2_b64`:
   - æ•°æ®è·¨åº¦å¤§ï¼Œéœ€è¦çµæ´»çš„offset
   - `ds_read2_b64` çš„å°offset (8Bå•ä½) æ›´çµæ´»
   - é…åˆ `v_add` æŒ‡ä»¤å¯ä»¥è¦†ç›–æ•´ä¸ªèŒƒå›´

### æŒ‡ä»¤æœ¬èº«çš„æ€§èƒ½å·®å¼‚

ä»å®éªŒç»“æœæ¨æ–­ï¼š

| æ–¹é¢ | `ds_read2_b64` | `ds_read2st64_b64` |
|------|----------------|-------------------|
| **å»¶è¿Ÿ** | ~20-40 cycles | ~20-40 cycles (ç›¸ä¼¼) |
| **ååé‡** | å¾ˆå¯èƒ½ç›¸åŒ | å¾ˆå¯èƒ½ç›¸åŒ |
| **åœ°å€è®¡ç®—** | ç®€å• (Ã—8) | ç¨å¤æ‚ (Ã—512) |
| **çµæ´»æ€§** | é«˜ (offset 0-255Ã—8B) | ä½ (offset 0-127Ã—512B) |

**å…³é”®æ´å¯Ÿ**: ä¸¤ä¸ªæŒ‡ä»¤çš„**ç¡¬ä»¶æ‰§è¡Œæ—¶é—´å¯èƒ½å‡ ä¹ç›¸åŒ**ï¼

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### ä¸ºä»€ä¹ˆ Strided layout æ…¢è¿™ä¹ˆå¤šï¼Ÿ

æ€§èƒ½å·®å¼‚ **ä¸æ˜¯æ¥è‡ªæŒ‡ä»¤ç±»å‹**ï¼Œè€Œæ˜¯æ¥è‡ªï¼š

1. **LDS Bank Conflicts** (æœ€ä¸»è¦åŸå› )
   ```
   Compact: 16B stride â†’ é¿å…å†²çª
   Strided: 64B stride â†’ å¯èƒ½å†²çªå¢åŠ 
   ```

2. **åœ°å€è®¡ç®—å¼€é”€**
   ```
   Compact: 2æ¡æŒ‡ä»¤
   Strided: 3-4æ¡æŒ‡ä»¤ + é¢å¤–çš„v_add
   ```

3. **æ•°æ®å±€éƒ¨æ€§**
   ```
   Compact: æ•°æ®ç´§å‡‘ï¼Œcacheå‹å¥½
   Strided: æ•°æ®åˆ†æ•£ï¼Œcache missæ›´å¤š
   ```

4. **å†…å­˜è®¿é—®æ¨¡å¼**
   ```
   Compact: é¡ºåºè®¿é—®
   Strided: è·¨strideè®¿é—®ï¼Œå¯èƒ½è§¦å‘æ›´å¤šLDSå»¶è¿Ÿ
   ```

## ç»“è®ºä¸å»ºè®®

### å…³äºæŒ‡ä»¤é€‰æ‹©

âœ… **`ds_read2_b64` vs `ds_read2st64_b64` æ€§èƒ½ç›¸è¿‘**
- ç¡¬ä»¶æ‰§è¡Œæ—¶é—´å‡ ä¹ç›¸åŒ
- å·®å¼‚ä¸»è¦åœ¨ç¼–ç æ–¹å¼ (offsetå•ä½ä¸åŒ)
- ç¼–è¯‘å™¨ä¼šæ ¹æ®è®¿é—®æ¨¡å¼è‡ªåŠ¨é€‰æ‹©

### å…³äºLDSä¼˜åŒ–

ğŸš€ **ä¼˜åŒ–é‡ç‚¹åº”è¯¥æ”¾åœ¨LDSå¸ƒå±€ï¼Œè€ŒéæŒ‡ä»¤ç±»å‹ï¼**

1. **ä¼˜å…ˆè€ƒè™‘**:
   - âœ… å‡å°‘LDS bank conflicts
   - âœ… æé«˜æ•°æ®å±€éƒ¨æ€§
   - âœ… ç´§å‡‘çš„å†…å­˜å¸ƒå±€

2. **æ¬¡è¦è€ƒè™‘**:
   - âš ï¸ å…·ä½“ä½¿ç”¨å“ªä¸ªDSæŒ‡ä»¤
   - âš ï¸ åœ°å€è®¡ç®—çš„å…·ä½“æ–¹å¼

### å¯¹ä½ çš„çŸ©é˜µä¹˜æ³•kernelçš„å»ºè®®

åŸºäºä½ çš„ `fp16_gemm_full_NTN_v4` kernelï¼š

```cpp
constexpr int SMEM_STRIDE = 64;  // ä½ å½“å‰çš„é…ç½®
```

**å½“å‰çŠ¶æ€åˆ†æ**:
- âœ… ä½¿ç”¨ `ds_read2st64_b64` æ˜¯**åˆç†çš„**
- âœ… 64B stride æ­£å¥½**é¿å…bank conflicts**
- âœ… MFMAè®¡ç®—å·²ç»**éšè—äº†LDSå»¶è¿Ÿ**

**æ˜¯å¦å€¼å¾—æ”¹æˆè¿ç»­å¸ƒå±€ï¼Ÿ**

âŒ **ä¸å»ºè®®æ”¹åŠ¨**ï¼Œå› ä¸ºï¼š

1. ä½ çš„MFMAå¯†åº¦å¾ˆé«˜ï¼ŒLDSå»¶è¿Ÿå·²è¢«éšè—
2. æ”¹layoutå¯èƒ½å¼•å…¥æ–°çš„bank conflicts
3. æ€§èƒ½æå‡ç©ºé—´æœ‰é™ï¼ˆ<5%ï¼‰ï¼Œè€Œå·¥ç¨‹é‡å¤§
4. å½“å‰ `SMEM_STRIDE=64` æ˜¯MI300Xçš„**æœ€ä½³å®è·µ**

**ä½•æ—¶è€ƒè™‘ä¼˜åŒ–ï¼Ÿ**

åªåœ¨ä»¥ä¸‹æƒ…å†µï¼š
- âœ… Profilingæ˜¾ç¤ºå¤§é‡LDS stall
- âœ… è®¡ç®—ä¸å¤Ÿå¯†é›†ï¼Œæ— æ³•éšè—LDSå»¶è¿Ÿ  
- âœ… Bank conflictç‡ > 10%

## éªŒè¯æ–¹æ³•

ä½¿ç”¨ `rocprof` è¯¦ç»†åˆ†æï¼š

```bash
rocprof --stats --hsa-trace ./lds_layout_benchmark

# å…³æ³¨æŒ‡æ ‡ï¼š
# - LDSBankConflict: LDS bankå†²çªç‡
# - VALUUtil: VALUåˆ©ç”¨ç‡
# - LDSInsts: LDSæŒ‡ä»¤æ•°é‡
# - MemUnitStalled: å†…å­˜å•å…ƒåœé¡¿å‘¨æœŸ
```

## é™„å½•ï¼šå®éªŒæ•°æ®

### å®Œæ•´Benchmarkè¾“å‡º

```
Compact layout:        145.276 us (baseline)
Strided layout:        405.189 us (178.91% slower)
Transpose access:      384.741 us (164.83% slower)
```

### æŒ‡ä»¤åˆ†å¸ƒ

```
ds_read2st64_b64:    2 occurrences
ds_read2_b64:        8 occurrences
Total ds_read*:     74 occurrences
```

---

**å®éªŒæ—¥æœŸ**: 2025-10-30  
**å·¥å…·**: HIP/ROCm 7.0.0, hipcc -O3  
**è®¾å¤‡**: AMD Instinct MI300X (gfx942)

